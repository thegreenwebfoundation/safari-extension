<!DOCTYPE html>
<html>
    <head>
        <title>Hello World!</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script type = "text/javascript" src="thegreenweb-utils.js" charset="UTF-8"></script>         
        <script>
    function respondToMessage(messageEvent) {
        if(messageEvent.name === "tabFocusSwitched"){
            doRequest();
        }
    }
    
    function doRequest()
    {
        activewindow = safari.application.activeBrowserWindow;
        url = getUrl(activewindow.activeTab.url);
            
        //document.getElementById("req").innerText = url;
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "http://api.cleanbits.net/json-multi.php?url="+url, true);
        xhr.onreadystatechange = function() {
             if (xhr.readyState == 4) {
                  var resp = JSON.parse(xhr.responseText);
                  showIcon(resp);
             }
        }
        xhr.send();
    }
    
    /**
     * Show the resulting icon based on the response
     */
    function showIcon(resp)
    {
      title = getTitle(resp);
      icon = getLinkImage(getIcon(resp),title);
      
      msg = icon + title;
      console.log(msg);
      document.getElementById('thegreenweb').innerHTML = msg;
    }  
 
    safari.self.browserWindow.addEventListener("message",respondToMessage,false);
    doRequest();
</script>
    </head>
    <body>
        <div id="thegreenweb"><img src='./images/green20x20.gif'/><span style="font-size: 12px; line-height: 20px; margin:2px 8px 15px; padding-bottom: 10px;">The Green Web</span></div>
    </body>
</html>