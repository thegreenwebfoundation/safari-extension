<html>
    <head><title></title>
        <script src="thegreenweb-utils.js"></script>
        <script>
/**
 * On request, send the data to the cleanbits api
 */
function respondToMessage(theMessageEvent) {
    console.log('receiving message');
    console.log(theMessageEvent);
    if(theMessageEvent.name === "greencheckSearch")
    {
       var locs = theMessageEvent.message;
       doSearchRequest(locs,0);
    }
}
 
safari.application.addEventListener("message",respondToMessage,false);

/**
 * Do the search request
 */
function doSearchRequest(data,tab)
{
    console.log(data);
    console.log('doing search request');
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "http://api.cleanbits.net/json-multi.php?data="+JSON.stringify(data), true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            var resp = JSON.parse(xhr.responseText);
            safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("greencheckSearchResult", resp);
        }
    }
    xhr.send();
}
</script>
</head>
<body>
    <script>
     var _gaq = _gaq || [];
     _gaq.push(['_setAccount', 'UA-3743032-3']);
     _gaq.push(['_trackPageview']);

     (function() {
       var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
       ga.src = 'https://ssl.google-analytics.com/ga.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
     })();
   </script>
    <div id="resp"></div>
    <div id="req"></div>
    <div id="log"></div>
</body>
</html>